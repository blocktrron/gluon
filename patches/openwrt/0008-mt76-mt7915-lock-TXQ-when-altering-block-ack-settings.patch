From: David Bauer <mail@david-bauer.net>
Date: Thu, 8 Feb 2024 20:27:46 +0100
Subject: mt76 mt7915: lock TXQ when altering block-ack settings

When there is a low of traffic fed to the HW from the kernel,
de-establishing a BlockAck session will lead to the HW output corrupted
frames where TA and RA contain the same client MAC-address.

Stopping TX from the OS seems to mitigate this issue.

[Patch contains commented out TX drainage, as tested first]

Signed-off-by: David Bauer <mail@david-bauer.net>

diff --git a/package/kernel/mt76/patches/0001-mt76-mt7915-lock-TXQ-when-altering-block-ack-setting.patch b/package/kernel/mt76/patches/0001-mt76-mt7915-lock-TXQ-when-altering-block-ack-setting.patch
new file mode 100644
index 0000000000000000000000000000000000000000..5853c8ad81c6721fa77b27e6995fc8f9f0635758
--- /dev/null
+++ b/package/kernel/mt76/patches/0001-mt76-mt7915-lock-TXQ-when-altering-block-ack-setting.patch
@@ -0,0 +1,113 @@
+From b0a09fa5ddabbb68d9d90a9d8f3bfc51e74aa629 Mon Sep 17 00:00:00 2001
+From: David Bauer <mail@david-bauer.net>
+Date: Thu, 8 Feb 2024 15:51:03 +0100
+Subject: [PATCH] mt76 mt7915: lock TXQ when altering block-ack settings
+
+When there is a low of traffic fed to the HW from the kernel,
+de-establishing a BlockAck session will lead to the HW output corrupted
+frames where TA and RA contain the same client MAC-address.
+
+Stopping TX from the OS seems to mitigate this issue.
+
+[Patch contains commented out TX drainage, as tested first]
+
+Signed-off-by: David Bauer <mail@david-bauer.net>
+---
+ mt7915/mcu.c | 65 ++++++++++++++++++++++++++++++++++++++++++++--------
+ 1 file changed, 55 insertions(+), 10 deletions(-)
+
+diff --git a/mt7915/mcu.c b/mt7915/mcu.c
+index 8224f8be..49d82736 100644
+--- a/mt7915/mcu.c
++++ b/mt7915/mcu.c
+@@ -681,32 +681,77 @@ out:
+ 				     MCU_EXT_CMD(BSS_INFO_UPDATE), true);
+ }
+ 
++static int mt7915_mcu_add_ba(struct mt7915_dev *dev,
++			     struct ieee80211_ampdu_params *params,
++			     bool enable,
++			     bool tx)
++{
++	struct mt7915_sta *msta = (struct mt7915_sta *)params->sta->drv_priv;
++	struct mt76_dev *mdev = &dev->mt76;
++	struct mt7915_vif *mvif = msta->vif;
++	struct mt76_queue *q = mvif->phy->mt76->q_tx[MT_TXQ_BE];
++	struct mt76_phy *pri_phy = dev->mt76.phys[MT_BAND0];
++	struct mt76_phy *ext_phy = dev->mt76.phys[MT_BAND1];
++	int ret;
++	int i;
++
++	/* Schedule pending TX */
++	mt76_txq_schedule_all(pri_phy);
++	if (ext_phy)
++		mt76_txq_schedule_all(ext_phy);
++
++	mt76_worker_disable(&dev->mt76.tx_worker);
++	mt76_for_each_q_rx(mdev, i) {
++		if (mdev->q_rx[i].ndesc)
++			napi_disable(&dev->mt76.napi[i]);
++	}
++	napi_disable(&dev->mt76.tx_napi);
++
++	/* Clean TXQ */
++	mt76_queue_tx_cleanup(dev, q, true);
++
++	ret = mt76_connac_mcu_sta_ba(&dev->mt76, &mvif->mt76, params,
++				      MCU_EXT_CMD(STA_REC_UPDATE),
++				      enable, tx);
++
++	local_bh_disable();
++	mt76_for_each_q_rx(mdev, i) {
++		if (mdev->q_rx[i].ndesc) {
++			napi_enable(&dev->mt76.napi[i]);
++			napi_schedule(&dev->mt76.napi[i]);
++		}
++	}
++	local_bh_enable();
++
++	local_bh_disable();
++	napi_enable(&dev->mt76.tx_napi);
++	napi_schedule(&dev->mt76.tx_napi);
++	local_bh_enable();
++
++	mt76_worker_enable(&dev->mt76.tx_worker);
++	// tasklet_schedule(&dev->mt76.irq_tasklet);
++
++	return ret;
++}
++
+ /** starec & wtbl **/
+ int mt7915_mcu_add_tx_ba(struct mt7915_dev *dev,
+ 			 struct ieee80211_ampdu_params *params,
+ 			 bool enable)
+ {
+ 	struct mt7915_sta *msta = (struct mt7915_sta *)params->sta->drv_priv;
+-	struct mt7915_vif *mvif = msta->vif;
+ 
+ 	if (enable && !params->amsdu)
+ 		msta->wcid.amsdu = false;
+ 
+-	return mt76_connac_mcu_sta_ba(&dev->mt76, &mvif->mt76, params,
+-				      MCU_EXT_CMD(STA_REC_UPDATE),
+-				      enable, true);
++	return mt7915_mcu_add_ba(dev, params, enable, true);
+ }
+ 
+ int mt7915_mcu_add_rx_ba(struct mt7915_dev *dev,
+ 			 struct ieee80211_ampdu_params *params,
+ 			 bool enable)
+ {
+-	struct mt7915_sta *msta = (struct mt7915_sta *)params->sta->drv_priv;
+-	struct mt7915_vif *mvif = msta->vif;
+-
+-	return mt76_connac_mcu_sta_ba(&dev->mt76, &mvif->mt76, params,
+-				      MCU_EXT_CMD(STA_REC_UPDATE),
+-				      enable, false);
++	return mt7915_mcu_add_ba(dev, params, enable, false);
+ }
+ 
+ static void
+-- 
+2.43.0
+
